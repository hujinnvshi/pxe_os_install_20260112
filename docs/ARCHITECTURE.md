# PXE 系统架构说明

## 一、系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端机器                                 │
│                         (虚拟机/物理服务器)                              │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                │ PXE Boot Request
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           网络层 (Ethernet)                             │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│ DHCP Server  │      │ TFTP Server  │      │ HTTP Server  │
│   (UDP 67)   │      │   (UDP 69)   │      │   (TCP 80)   │
├──────────────┤      ├──────────────┤      ├──────────────┤
│ • IP 分配    │      │ • pxelinux.0  │      │ • ISO 镜像   │
│ • TFTP 指向  │      │ • vmlinuz     │      │ • Kickstart  │
│ • 引导文件   │      │ • initrd.img  │      │ • Preseed    │
└──────────────┘      └──────────────┘      └──────────────┘
```

## 二、工作流程详解

### 1. PXE 启动流程

```
步骤 1: DHCP Discovery
┌─────────┐                              ┌────────────┐
│ 客户端  │ ──── DHCP Discover广播 ─────>│ DHCP Server│
└─────────┘                              └────────────┘

步骤 2: DHCP Offer
┌─────────├────────────────────────────── DHCP Offer ──────┐
│         │  • IP: 192.168.1.100                           │
│         │  • Next-Server: 192.168.1.10 (TFTP)            │
│         │  • Filename: pxelinux.0                        │
│         │                                                │

步骤 3: DHCP Request
┌─────────┼────── DHCP Request ───────>│                   │
│         │                                                │

步骤 4: DHCP ACK
┌─────────┼<──── DHCP ACK ────────────┤                   │
│         │                                                │

步骤 5: TFTP Request
┌─────────┼──── TFTP Read Request ────>│ TFTP Server      │
│         │   Request: pxelinux.0     │                  │

步骤 6: TFTP Data
┌─────────┼<──── pxelinux.0 ──────────┤                  │

步骤 7: Load pxelinux.0
┌─────────┼─ 执行 pxelinux.0 ──────────>│                  │
│         │                                                │

步骤 8: Load Config
┌─────────┼──── TFTP: pxelinux.cfg/default ────>│          │

步骤 9: Display Menu
┌─────────┼─ 显示启动菜单 ────────────────────────┤          │
│         │                                                │
│         │  1. Install CentOS 7                          │
│         │  2. Install Ubuntu 20.04                      │
│         │  3. Boot from local disk                      │
│         │                                                │

步骤 10: User Selection & Kernel Load
┌─────────┼─── TFTP: vmlinuz + initrd.img ──────>│          │

步骤 11: Kernel Boot
┌─────────┼─── 内核启动，initrd 解析 ──────────────────────────┤
│         │                                                │

步骤 12: HTTP Request Kickstart
┌─────────┼─── HTTP GET /ks/centos7-ks.cfg ────>│ HTTP Server│

步骤 13: Installation
┌─────────┼─── 根据 Kickstart 自动安装 ─────────────────────────┤
│         │  • 分区                                          │
│         │  • 安装软件包                                    │
│         │  • 配置系统                                      │
│         │  • 执行 post 脚本                                │
│         │                                                │

步骤 14: Reboot
┌─────────┼─── 安装完成，重启 ─────────────────────────────────────┘
```

### 2. 文件传输流程

```
┌────────────────────────────────────────────────────────────────────┐
│                        客户端启动过程                              │
└────────────────────────────────────────────────────────────────────┘

1. 网卡固件
   └──> 发送 DHCP Discover

2. DHCP Server 响应
   ├──> IP: 192.168.1.100
   ├──> Next-Server: 192.168.1.10 (TFTP)
   └──> Filename: pxelinux.0

3. TFTP 传输
   ├──> pxelinux.0          (10KB)    ← 引导加载器
   ├──> pxelinux.cfg/default (2KB)    ← 启动菜单
   ├──> ldlinux.c32        (20KB)    ← 辅助模块
   ├──> menu.c32           (15KB)    ← 菜单模块
   ├──> vmlinuz            (6MB)     ← Linux 内核
   └──> initrd.img         (50MB)    ← 初始化内存盘

4. HTTP 传输（安装过程中）
   ├──> ks/centos7-ks.cfg  (5KB)     ← Kickstart 配置
   └──> iso/centos7/*      (2-8GB)   ← 软件包

总计传输: 约 8-10GB（取决于系统）
```

## 三、组件说明

### 1. DHCP Server

**作用**：
- 分配 IP 地址
- 指定 TFTP 服务器地址
- 指定引导文件名

**关键配置**：
```conf
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    next-server 192.168.1.10;    # TFTP 服务器
    filename "pxelinux.0";        # 引导文件
}
```

**数据包流向**：
```
Client (255.255.255.255) ──> DHCP Server (监听 0.0.0.0:67)
Client <─── DHCP OFFER ──── DHCP Server
Client ───> DHCP REQUEST ──> DHCP Server
Client <──── DHCP ACK ───── DHCP Server
```

### 2. TFTP Server

**作用**：
- 提供 PXE 引导文件
- 传输内核和 initrd

**目录结构**：
```
/tftpboot/
├── pxelinux.0              # 引导加载器
├── ldlinux.c32            # 库文件
├── menu.c32               # 菜单模块
├── pxelinux.cfg/
│   ├── default            # 默认配置
│   └── 01-00-0c-29-xx-xx  # MAC 地址特定配置
├── centos7/
│   ├── vmlinuz            # 内核
│   └── initrd.img         # 初始内存盘
└── centos8/
    ├── vmlinuz
    └── initrd.img
```

**特点**：
- 基于 UDP
- 无认证机制
- 小文件传输优化

### 3. HTTP Server

**作用**：
- 提供完整的 ISO 镜像
- 提供 Kickstart/Preseed 配置

**目录结构**：
```
/var/www/html/
├── iso/
│   ├── centos7/           # CentOS 7 完整镜像
│   │   ├── Packages/
│   │   ├── repodata/
│   │   └── images/
│   └── ubuntu2004/        # Ubuntu 镜像
└── ks/
    ├── centos7-ks.cfg     # CentOS 7 自动安装配置
    └── ubuntu2004-preseed.cfg  # Ubuntu 配置
```

**Nginx 配置要点**：
```nginx
location /iso/ {
    alias /usr/share/nginx/html/iso/;
    autoindex on;          # 允许目录浏览
    client_max_body_size 10G;  # 支持大文件
}

location /ks/ {
    alias /usr/share/nginx/html/ks/;
    add_header Cache-Control "no-cache";  # 禁用缓存
}
```

### 4. Kickstart/Preseed

**Kickstart (RHEL/CentOS)**：
- 定义安装全过程
- 支持自动化分区、网络、用户配置
- 支持 %post 脚本进行后续配置

**Preseed (Debian/Ubuntu)**：
- 类似 Kickstart
- 使用 debconf-set-selections 格式

## 四、网络拓扑

### 基础拓扑

```
                ┌─────────────────┐
                │   交换机/路由器  │
                │   192.168.1.1   │
                └────────┬────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ PXE 服务器   │ │   虚拟机 1    │ │   虚拟机 2    │
│ 192.168.1.10 │ │  (DHCP客户端) │ │  (DHCP客户端) │
│              │ │              │ │              │
│ • DHCP       │ │ • 获取 IP    │ │ • 获取 IP    │
│ • TFTP       │ │ • 下载引导   │ │ • 下载引导   │
│ • HTTP       │ │ • 安装系统   │ │ • 安装系统   │
└──────────────┘ └──────────────┘ └──────────────┘
```

### 隔离网络拓扑（推荐生产环境）

```
┌─────────────────────────────────────────────────────────┐
│                   管理网络 (192.168.1.x)                 │
│                                                          │
│  ┌────────────┐      ┌────────────┐      ┌────────────┐ │
│  │ 管理工作站 │ ────>│  交换机    │<─────│ PXE 服务器 │ │
│  └────────────┘      └──────┬─────┘      └────────────┘ │
└─────────────────────────────┼────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                   安装网络 (10.0.0.x)                   │
│                                                          │
│  ┌────────────┐      ┌────────────┐      ┌────────────┐ │
│  │ 待安装 VM1 │<────>│  交换机    │<────>│ 待安装 VM2 │ │
│  └────────────┘      └────────────┘      └────────────┘ │
│                            ▲                            │
└────────────────────────────┼────────────────────────────┘
                             │
                      ┌──────┴──────┐
                      │ PXE 服务器  │
                      │ 10.0.0.10   │
                      │ • DHCP      │
                      │ • TFTP      │
                      │ • HTTP      │
                      └─────────────┘
```

## 五、时间线

典型的 PXE 安装时间线：

```
T+0s    客户端启动，PXE ROM 初始化
T+2s    DHCP 请求/响应
T+5s    TFTP 下载 pxelinux.0 (10KB)
T+8s    显示启动菜单
T+10s   用户选择安装项
T+15s   TFTP 下载内核 (6MB)
T+45s   TFTP 下载 initrd (50MB)
T+60s   内核启动，initrd 加载
T+70s   HTTP 下载 Kickstart 配置 (5KB)
T+75s   开始安装（分区、格式化）
T+180s  HTTP 下载软件包（取决于网络速度）
T+600s  安装完成，重启
T+620s  从硬盘启动新系统

总计：约 10-15 分钟（取决于网络和系统大小）
```

## 六、安全考虑

1. **网络隔离**：
   - 生产环境使用独立网络
   - 限制 DHCP 服务器范围

2. **访问控制**：
   - 使用防火墙限制访问
   - 定期审计 PXE 配置

3. **数据安全**：
   - Kickstart 文件避免明文密码
   - 使用 HTTPS 传输敏感配置

4. **生命周期管理**：
   - 安装完成后禁用 PXE 服务
   - 定期更新 ISO 镜像
