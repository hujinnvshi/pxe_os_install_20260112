# CentOS 7 Kickstart é…ç½® - ç”Ÿäº§çŽ¯å¢ƒ
# ç‰¹ç‚¹ï¼šå®‰å…¨é…ç½®ï¼Œé€‚åˆç”Ÿäº§éƒ¨ç½²

# ============================================
# åŸºç¡€é…ç½®
# ============================================
install
url --url="http://192.168.1.10:8080/iso/centos7"
lang en_US.UTF-8
keyboard us
network --bootproto=dhcp --hostname=centos7-prod

# root å¯†ç ï¼ˆè¯·ä¿®æ”¹ï¼ï¼‰
# ç”Ÿæˆæ–¹æ³•: openssl passwd -1 "yourpassword"
rootpw --iscrypted $1$test_hash_change_me

# ============================================
# åˆ†åŒºé…ç½®ï¼ˆç”Ÿäº§çŽ¯å¢ƒæŽ¨èï¼‰
# ============================================
clearpart --all --initlabel

# æ‰‹åŠ¨åˆ†åŒºï¼ˆæ›´å®‰å…¨ï¼‰
part /boot --fstype=xfs --size=1024 --ondisk=sda
part swap --size=4096 --ondisk=sda
part pv.01 --size=1 --grow --ondisk=sda
volgroup centos pv.01
logvol / --fstype=xfs --name=root --vgname=centos --size=10240 --grow
logvol /home --fstype=xfs --name=home --vgname=centos --size=2048
logvol /var --fstype=xfs --name=var --vgname=centos --size=8192
logvol /var/log --fstype=xfs --name=log --vgname=centos --size=2048
logvol /tmp --fstype=xfs --name=tmp --vgname=centos --size=2048

# ============================================
# è®¤è¯é…ç½®
# ============================================
authconfig --enableshadow --passalgo=sha512

# ============================================
# å®‰å…¨é…ç½®ï¼ˆç”Ÿäº§çŽ¯å¢ƒï¼‰
# ============================================
selinux --enforcing
firewall --enabled --service=ssh --service=http --service=https

# ============================================
# æ˜¾ç¤ºé…ç½®
# ============================================
text
skipx

# ============================================
# è½¯ä»¶åŒ…é€‰æ‹©ï¼ˆæœ€å°åŒ– + å¿…è¦å·¥å…·ï¼‰
# ============================================
%packages --nobase
@core

# åŸºç¡€å·¥å…·
vim-minimal
wget
curl
git
net-tools
bash-completion

# å®‰å…¨å·¥å…·
sudo
policycoreutils-python
setools-console

%end

# ============================================
# å®‰è£…å‰è„šæœ¬
# ============================================
%pre
#!/bin/bash
echo "=========================================="
echo "CentOS 7 Production Installation"
echo "Date: $(date)"
echo "=========================================="

# ç¡¬ä»¶æ£€æŸ¥
echo "Hardware Info:"
grep "model name" /proc/cpuinfo | head -1
free -h
df -h

%end

# ============================================
# å®‰è£…åŽè„šæœ¬ï¼ˆç”Ÿäº§çŽ¯å¢ƒé…ç½®ï¼‰
# ============================================
%post --log=/root/ks-post.log
#!/bin/bash

echo "=========================================="
echo "Starting post-installation configuration"
echo "Environment: PRODUCTION"
echo "=========================================="

# è®¾ç½®ç”Ÿäº§çŽ¯å¢ƒå˜é‡
export ENV_TYPE="production"
export FIREWALL_POLICY="strict"          # ä¸¥æ ¼é˜²ç«å¢™
export SELINUX_MODE="enforcing"          # SELinux å¼ºåˆ¶
export SSH_CONFIG="secure"               # ç¦ç”¨ rootï¼Œå…è®¸å¯†ç 
export CONFIGURE_TUNE="true"
export CONFIGURE_NTP="true"
export CONFIGURE_USERS="true"
export CONFIGURE_REPOS="true"

# ä¸‹è½½å¹¶æ‰§è¡Œé€šç”¨é…ç½®è„šæœ¬
cd /root
curl -O http://192.168.1.10:8080/ks/common-post-install.sh
if [ -f common-post-install.sh ]; then
    bash common-post-install.sh
else
    echo "WARNING: Failed to download common-post-install.sh"
    # å³ä½¿ä¸‹è½½å¤±è´¥ï¼Œä¹Ÿæ‰§è¡ŒåŸºæœ¬é…ç½®
fi

# ç”Ÿäº§çŽ¯å¢ƒé¢å¤–å®‰å…¨é…ç½®
echo "Applying production security hardening..."

# ç¦ç”¨ root SSH ç™»å½•
sed -i 's/^#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# ç¦ç”¨ç©ºå¯†ç ç™»å½•
sed -i 's/^#PermitEmptyPasswords yes/PermitEmptyPasswords no/' /etc/ssh/sshd_config
sed -i 's/^PermitEmptyPasswords yes/PermitEmptyPasswords no/' /etc/ssh/sshd_config

# ç¦ç”¨ .rhosts æ–‡ä»¶æ”¯æŒ
sed -i 's/^#IgnoreRhosts yes/IgnoreRhosts yes/' /etc/ssh/sshd_config

systemctl restart sshd

# é…ç½®é˜²ç«å¢™ï¼ˆé¢å¤–è§„åˆ™ï¼‰
if command -v firewall-cmd &> /dev/null; then
    # åªä¿ç•™å¿…è¦ç«¯å£
    firewall-cmd --permanent --add-service=ssh
    firewall-cmd --permanent --add-service=http
    firewall-cmd --permanent --add-service=https
    firewall-cmd --reload
fi

# é…ç½®æ—¥å¿—è½®è½¬
cat > /etc/logrotate.d/production << 'EOF'
/var/log/messages /var/log/secure /var/log/cron {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    sharedscripts
    postrotate
        /bin/kill -HUP $(cat /var/run/rsyslog.pid 2> /dev/null) 2> /dev/null || true
    endscripts
}

/var/log/httpd/*log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0644 apache apache
    sharedscripts
    postrotate
        /bin/systemctl reload httpd > /dev/null 2>&1 || true
    endscripts
}
EOF

# å®‰è£…å®‰å…¨æ›´æ–°
echo "Installing security updates..."
yum install -y epel-release
yum update -y --security

# å®‰è£…ç›‘æŽ§å·¥å…·
yum install -y rsyslog logrotate

# é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
yum install -y yum-cron
sed -i 's/^apply_updates = no/apply_updates = yes/' /etc/yum/yum-cron.conf
sed -i 's/^apply_updates = yes/apply_updates = security/' /etc/yum/yum-cron-hourly.conf
systemctl enable yum-cron
systemctl start yum-cron

# é…ç½®å†…æ ¸å‚æ•°
cat >> /etc/sysctl.d/99-security.conf << 'EOF'
# å®‰å…¨åŠ å›º
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# TCP åŠ å›º
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5

# æ–‡ä»¶æè¿°ç¬¦
fs.file-max = 65535
EOF

sysctl -p /etc/sysctl.d/99-security.conf

# é…ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
cat >> /etc/security/limits.d/99-security.conf << 'EOF'
# å®‰å…¨é™åˆ¶
* soft core 0
* hard core 0
* soft nproc 4096
* hard nproc 8192
EOF

# ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
systemctl disable postfix
systemctl stop postfix

# ç¦ç”¨ Ctrl+Alt+Delete
sed -i 's/^exec/#exec/' /etc/init/control-alt-delete.conf 2>/dev/null || true

# é…ç½® MOTDï¼ˆç”Ÿäº§çŽ¯å¢ƒè­¦å‘Šï¼‰
cat > /etc/motd << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘  ðŸ›¡ï¸  PRODUCTION ENVIRONMENT ðŸ›¡ï¸                          â•‘
â•‘                                                            â•‘
â•‘  Security Status:                                         â•‘
â•‘  - Firewall: ENABLED (strict mode)                       â•‘
â•‘  - SELinux: ENFORCING                                     â•‘
â•‘  - Root Login: DISABLED                                  â•‘
â•‘  - Auto Updates: ENABLED                                 â•‘
â•‘                                                            â•‘
â•‘  âš ï¸  IMPORTANT:                                          â•‘
â•‘  - Change default passwords immediately                 â•‘
â•‘  - Review firewall rules                                 â•‘
â•‘  - Monitor system logs                                   â•‘
â•‘  - Keep system updated                                   â•‘
â•‘                                                            â•‘
â•‘  Contact: admin@example.com                              â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

# åˆ›å»ºå®‰å…¨æ£€æŸ¥è„šæœ¬
cat > /root/security-check.sh << 'EOF'
#!/bin/bash
echo "=== Production Security Check ==="
echo ""
echo "1. Firewall Status:"
firewall-cmd --list-all
echo ""
echo "2. SELinux Status:"
getenforce
echo ""
echo "3. SSH Configuration:"
grep -E "^PermitRootLogin|^PasswordAuthentication" /etc/ssh/sshd_config
echo ""
echo "4. Listening Ports:"
ss -tuln | grep LISTEN
echo ""
echo "5. Last Login:"
last -n 5
EOF

chmod +x /root/security-check.sh

# æ¸…ç†
echo "Cleaning up..."
yum clean all
rm -rf /var/cache/yum/*

# å¼ºåˆ¶ SELinux ä¸Šä¸‹æ–‡é‡ç½®
restorecon -R /root /etc /var

echo "=========================================="
echo "Production environment setup completed!"
echo "Run /root/security-check.sh for security audit"
echo "=========================================="

%end

# ============================================
# å®‰è£…å®Œæˆ
# ============================================
reboot
