# Ubuntu 22.04 LTS (Jammy Jellyfish) Preseed/Autoinstall 配置
# 注意：Ubuntu 22.04 默认使用 subiquity 安装程序，支持 cloud-init autoinstall

# ============================================
# 对于 Ubuntu 22.04，推荐使用 cloud-init autoinstall
# 这个文件提供传统 preseed 方式的兼容配置
# ============================================

# ============================================
# 本地化设置
# ============================================
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# ============================================
# 网络配置
# ============================================
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean false
d-i netcfg/get_hostname string ubuntu2204
d-i netcfg/get_domain string local
d-i netcfg/wireless_wep string

# ============================================
# 镜像设置
# ============================================
d-i mirror/country string manual
d-i mirror/http/hostname string 192.168.1.10
d-i mirror/http/directory string /iso/ubuntu2204
d-i mirror/http/proxy string

# ============================================
# 时区和时钟设置
# ============================================
d-i time/zone string Asia/Shanghai
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

# ============================================
# 分区配置
# ============================================
# 使用 LVM 自动分区
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true

# 分区方案（类似于 20.04 但增加了 /home 大小）
d-i partman-auto/expert_recipe string \
    boot-root :: \
        512 512 512 ext4 \
            $primary{ } \
            $bootable{ } \
            method{ format } \
            format{ } \
            use_filesystem{ } \
            filesystem{ ext4 } \
            mountpoint{ /boot } \
        . \
        15360 10240 -1 ext4 \
            $lvmok{ } \
            method{ format } \
            format{ } \
            use_filesystem{ } \
            filesystem{ ext4 } \
            mountpoint{ / } \
        . \
        8192 4096 -1 ext4 \
            $lvmok{ } \
            method{ format } \
            format{ } \
            use_filesystem{ } \
            filesystem{ ext4 } \
            mountpoint{ /home } \
        . \
        4096 2048 -1 linux-swap \
            $lvmok{ } \
            method{ swap } \
            format{ } \
        .

# 确认分区
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# ============================================
# 用户和密码设置
# ============================================
# 禁用 root 登录
d-i passwd/root-login boolean false

# 创建普通用户
d-i passwd/user-fullname string Deploy User
d-i passwd/username string deploy
d-i passwd/user-password password Deploy123!
d-i passwd/user-password-again password Deploy123!
d-i passwd/user-default-groups string audio cdrom video sudo adm dialout

# ============================================
# 认证设置
# ============================================
d-i passwd/shadow boolean true

# ============================================
# 引导装载程序
# ============================================
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default

# ============================================
# 软件包选择
# ============================================
tasksel tasksel/first multiselect standard, ubuntu-server

# 安装额外软件包
d-i pkgsel/include string \
    openssh-server \
    vim \
    curl \
    wget \
    git \
    htop \
    tmux \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release

# 语言包
d-i pkgsel/install-language-support boolean false
d-i pkgsel/language-packs multiselect en

# 更新设置
d-i pkgsel/upgrade select safe-upgrade

# ============================================
# Ubuntu Advantage（可选）
# ============================================
d-i ubuntu-advantage/manage-ua boolean false

# ============================================
# 安装后设置
# ============================================
d-i apt-setup/use_mirror boolean true
d-i apt-setup/security_host string security.ubuntu.com

# ============================================
# 安装后脚本
# ============================================
d-i preseed/late_command string \
    chroot /target chmod 755 /root; \
    chroot /target wget -O /root/post-install.sh http://192.168.1.10:8080/ks/ubuntu2204-post.sh || true; \
    chroot /target chmod +x /root/post-install.sh || true; \
    chroot /target /root/post-install.sh || true; \
    chroot /target rm -f /root/post-install.sh

# ============================================
# 完成安装
# ============================================
d-i finish-install/reboot_in_progress note
d-i cdrom-detect/eject boolean false
d-i finish-install/keep-consoles boolean true
d-i finish-install/automatic-reboot boolean true

# ============================================
# 系统配置
# ============================================
d-i debian-installer/quiet boolean true
d-i hw-detect/load_firmware boolean true

# ============================================
# Ubuntu 22.04 Cloud-init Autoinstall 替代方案
# ============================================
#
# Ubuntu 22.04 更推荐使用 cloud-init autoinstall
# 创建文件: /var/www/html/ks/ubuntu2204-autoinstall.yaml
#
# 示例 autoinstall.yaml 内容：
#
# ---
# autoinstall:
#   version: 1
#   identity:
#     hostname: ubuntu2204
#     password: "$6$exDY1mhS4KUYCE/2$zMnVM.Z1SHV/X/zWOyvL1KqOp.E.hL/wNqtY.b2uF3mBhzf7xGL8uXl7qKq.GZ1E4C5sOVdhnPdGLGx8Vh8x0"
#     username: deploy
#   ssh:
#     install-server: true
#     allow-pw: true
#   locale: en_US.UTF-8
#   timezone: Asia/Shanghai
#   storage:
#     layout:
#       name: lvm
#   packages:
#     - ubuntu-server
#     - openssh-server
#     - vim
#     - curl
#     - wget
#     - git
#     - htop
#     - tmux
#     - build-essential
#   network:
#     version: 2
#     ethernets:
#       any:
#         match:
#           name: "e*"
#         dhcp4: true
#
# 使用方法：
# 1. 将 autoinstall.yaml 放在 HTTP 服务器上
# 2. 修改 PXE 启动菜单为：
#    LABEL ubuntu2204-auto
#        KERNEL ubuntu2204/linux
#        APPEND initrd=ubuntu2204/initrd ds=nocloud;s=http://192.168.1.10:8080/ks/ ---
#
# ============================================
# post-install.sh 示例内容
# ============================================
#
# #!/bin/bash
# set -e
#
# echo "=========================================="
# echo "Ubuntu 22.04 Post-Installation"
# echo "=========================================="
#
# # 更新系统
# export DEBIAN_FRONTEND=noninteractive
# apt-get update
# apt-get upgrade -y
#
# # 安装额外工具
# apt-get install -y \
#     ufw \
#     fail2ban \
#     net-tools \
#     traceroute \
#     mtr \
#     iotop \
#     nethogs
#
# # 配置 UFW 防火墙
# ufw default deny incoming
# ufw default allow outgoing
# ufw allow 22/tcp
# ufw --force enable
#
# # 配置 SSH
# sed -i 's/^#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
# sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
# systemctl restart sshd
#
# # 系统优化
# echo "* soft nofile 65535" >> /etc/security/limits.conf
# echo "* hard nofile 65535" >> /etc/security/limits.conf
#
# echo "net.ipv4.tcp_fin_timeout = 30" >> /etc/sysctl.conf
# echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
# sysctl -p
#
# # 配置 MOTD
# cat > /etc/motd << 'EOF'
# ========================================
# Welcome to Ubuntu 22.04 LTS
# System installed via PXE
# Please change default passwords!
# ========================================
# EOF
#
# # 清理
# apt-get clean
# apt-get autoremove -y
#
# echo "=========================================="
# echo "Post-installation completed!"
# echo "=========================================="
# echo "$(date)" > /var/log/post-install.log
#
# exit 0
#
