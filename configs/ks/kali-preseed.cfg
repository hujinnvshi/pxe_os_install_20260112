# Kali Linux Preseed 配置文件
# Kali 基于 Debian，可以使用 Debian 的 Preseed 机制

# ============================================
# 本地化设置
# ============================================
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# ============================================
# 网络配置
# ============================================
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean false
d-i netcfg/get_hostname string kali
d-i netcfg/get_domain string local
d-i netcfg/wireless_wep string

# ============================================
# 镜像设置
# ============================================
d-i mirror/country string manual
d-i mirror/http/hostname string 192.168.1.10
d-i mirror/http/directory string /iso/kali
d-i mirror/http/proxy string

# ============================================
# 时区和时钟设置
# ============================================
d-i time/zone string Asia/Shanghai
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

# ============================================
# 分区配置
# ============================================
# 使用 LVM 自动分区
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-auto-lvm/guided_size string max
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# ============================================
# 用户和密码设置
# ============================================
# 禁用 root 登录（Kali 默认）
d-i passwd/root-login boolean false

# 创建普通用户（Kali 默认用户名：kali）
d-i passwd/user-fullname string Kali User
d-i passwd/username string kali
d-i passwd/user-password password kali
d-i passwd/user-password-again password kali

# sudo 权限
d-i passwd/user-default-groups string audio cdrom video sudo plugdev netdev

# ============================================
# 认证设置
# ============================================
d-i passwd/shadow boolean true

# ============================================
# 引导装载程序
# ============================================
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default

# ============================================
# 软件包选择
# ============================================
tasksel tasksel/first multiselect standard, ssh-server

# Kali 工具集（可选 - 会很慢）
# d-i pkgsel/include string kali-desktop-gnome kali-tools-top10

# 基础工具
d-i pkgsel/include string \
    openssh-server \
    vim \
    curl \
    wget \
    git \
    tmux \
    net-tools

# 不安装推荐软件包（加快安装速度）
d-i pkgsel/install-language-support boolean false
d-i pkgsel/language-packs multiselect

# 更新设置
d-i pkgsel/upgrade select safe-upgrade

# 弹出软件包提示时选择不弹出
d-i pkgsel/install-politics multiselect none

# ============================================
# 安装后设置
# ============================================
d-i apt-setup/use_mirror boolean true
d-i apt-setup/security_host bool false

# ============================================
# 安装后脚本
# ============================================
d-i preseed/late_command string \
    chroot /target wget -O /root/post-install.sh http://192.168.1.10:8080/ks/kali-post.sh || true; \
    chroot /target chmod +x /root/post-install.sh || true; \
    chroot /target /root/post-install.sh || true; \
    chroot /target rm -f /root/post-install.sh

# ============================================
# 完成安装
# ============================================
d-i finish-install/reboot_in_progress note
d-i cdrom-detect/eject boolean false
d-i finish-install/keep-consoles boolean true
d-i finish-install/automatic-reboot boolean true

# ============================================
# Kali Linux 后安装脚本示例
# ============================================
#
# 创建文件: /var/www/html/ks/kali-post.sh
#
# #!/bin/bash
# set -e
#
# echo "=========================================="
# echo "Kali Linux Post-Installation"
# echo "=========================================="
#
# # 更新系统
# export DEBIAN_FRONTEND=noninteractive
# apt-get update
# apt-get upgrade -y
#
# # 安装额外的 Kali 工具（可选）
# # apt-get install -y \
# #     kali-tools-top10 \
# #     kali-tools-wireless \
# #     kali-tools-web \
# #     kali-tools-passwords
#
# # 安装常用工具
# apt-get install -y \
#     fish \
#     htop \
#     btop \
#     ufw \
#     fail2ban
#
# # 配置防火墙
# ufw default deny incoming
# ufw default allow outgoing
# ufw allow 22/tcp
# ufw --force enable
#
# # 配置 SSH
# sed -i 's/^#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
# systemctl restart sshd
#
# # 配置时区
# timedatectl set-timezone Asia/Shanghai
#
# # 修改默认密码（重要！）
# echo "kali:NewSecurePassword123" | chpasswd
#
# echo "=========================================="
# echo "Post-installation completed!"
# echo "Please change the default 'kali' user password!"
# echo "=========================================="
#
# exit 0
#
