# CentOS 7 Kickstart 配置 - 测试环境
# 特点：关闭安全限制，方便开发和测试

# ============================================
# 基础配置
# ============================================
install
url --url="http://192.168.1.10:8080/iso/centos7"
lang en_US.UTF-8
keyboard us
network --bootproto=dhcp --hostname=centos7-test

# root 密码：root123 (测试环境)
rootpw --plaintext root123

# ============================================
# 分区配置（简单分区）
# ============================================
clearpart --all --initlabel
autopart --type=lvm

# ============================================
# 认证配置
# ============================================
authconfig --enableshadow --passalgo=sha512

# ============================================
# 安全配置（测试环境）
# ============================================
selinux --disabled
firewall --disabled

# ============================================
# 显示配置
# ============================================
text
skipx

# ============================================
# 软件包选择（包含开发工具）
# ============================================
%packages --nobase
@core
@development
@debugging

# 基础工具
vim
wget
curl
git
net-tools
telnet
tcpdump
nmap
htop
tmux
screen
tree
lsof

# 开发工具
gcc
make
automake
cmake
python3
python3-pip

%end

# ============================================
# 安装前脚本
# ============================================
%pre
#!/bin/bash
echo "=========================================="
echo "CentOS 7 Testing Installation"
echo "Date: $(date)"
echo "=========================================="
%end

# ============================================
# 安装后脚本（测试环境配置）
# ============================================
%post --log=/root/ks-post.log
#!/bin/bash

echo "=========================================="
echo "Starting post-installation configuration"
echo "Environment: TESTING"
echo "=========================================="

# 设置测试环境变量
export ENV_TYPE="testing"
export FIREWALL_POLICY="open"           # 关闭防火墙
export SELINUX_MODE="disabled"          # 关闭 SELinux
export SSH_CONFIG="permissive"          # 允许 root + 密码
export CONFIGURE_TUNE="true"
export CONFIGURE_NTP="true"
export CONFIGURE_USERS="true"
export CONFIGURE_REPOS="true"

# 下载并执行通用配置脚本
cd /root
curl -O http://192.168.1.10:8080/ks/common-post-install.sh
if [ -f common-post-install.sh ]; then
    bash common-post-install.sh
else
    echo "WARNING: Failed to download common-post-install.sh"
fi

# 额外的测试环境配置
echo "Configuring additional testing features..."

# 禁用 SELinux（永久）
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
sed -i 's/^SELINUX=permissive/SELINUX=disabled/' /etc/selinux/config

# 配置 SSH（允许 root 登录）
sed -i 's/^#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin no/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

systemctl restart sshd

# 安装额外开发工具
echo "Installing additional development tools..."
yum install -y epel-release
yum install -y htop iftop iotop jq rsync bc

# 配置历史记录
echo 'export HISTTIMEFORMAT="%F %T "' >> /root/.bashrc
echo 'export HISTSIZE=10000' >> /root/.bashrc
echo 'export HISTFILESIZE=20000' >> /root/.bashrc

# 创建测试目录
mkdir -p /root/test
mkdir -p /data/test

# 配置 MOTD
cat > /etc/motd << 'EOF'
╔══════════════════════════════════════════════════════════╗
║                                                            ║
║  ⚠️  TESTING ENVIRONMENT - TESTING ENVIRONMENT ⚠️        ║
║                                                            ║
║  - Firewall: DISABLED                                     ║
║  - SELinux: DISABLED                                      ║
║  - Root Login: ENABLED                                    ║
║                                                            ║
║  ⚠️  NOT FOR PRODUCTION USE! ⚠️                          ║
║                                                            ║
║  Change default passwords immediately!                   ║
║                                                            ║
╚══════════════════════════════════════════════════════════╝
EOF

# 清理
echo "Cleaning up..."
yum clean all

echo "=========================================="
echo "Testing environment setup completed!"
echo "=========================================="

%end

# ============================================
# 安装完成
# ============================================
reboot
