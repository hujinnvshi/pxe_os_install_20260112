# CentOS 7 Kickstart 配置文件
# 用于自动化安装 CentOS 7 系统

# ============================================
# 安装方式
# ============================================
install

# 从网络安装（HTTP/FTP/NFS）
url --url="http://192.168.1.10:8080/iso/centos7"

# 如果使用完整安装光盘，使用下面这行：
# cdrom

# 如果使用 NFS 服务器：
# nfs --server=192.168.1.10 --dir=/iso/centos7

# ============================================
# 语言和键盘配置
# ============================================
lang en_US.UTF-8
keyboard us

# ============================================
# 网络配置
# ============================================
# 自动获取 IP（DHCP）
network --onboot=yes --device=eth0 --bootproto=dhcp --noipv6

# 如果使用静态 IP：
# network --onboot=yes --device=eth0 --bootproto=static --ip=192.168.1.100 --netmask=255.255.255.0 --gateway=192.168.1.1 --nameserver=8.8.8.8

# ============================================
# 时区和密码
# ============================================
timezone Asia/Shanghai --isUtc
# root 密码：password123（请修改！）
# 生成加密密码的命令：openssl passwd -1 "yourpassword"
rootpw --iscrypted $1$random$salt...请替换为实际加密密码

# 或者使用明文（不推荐）：
# rootpw "yourpassword"

# ============================================
# 引导装载程序
# ============================================
# 安装引导装载程序到 MBR
bootloader --location=mbr --boot-drive=sda

# 如果使用 GPT 分区和 UEFI：
# bootloader --location=partition --driveorder=sda

# ============================================
# 分区配置
# ============================================
# 清除所有现有分区
clearpart --all --initlabel

# 自动分区（使用 LVM）
# autopart --type=lvm

# 或者手动分区（推荐用于生产环境）
part /boot --fstype=xfs --size=500 --ondisk=sda
part swap --size=2048 --ondisk=sda
part pv.01 --size=1 --grow --ondisk=sda
volgroup centos pv.01
logvol / --fstype=xfs --name=root --vgname=centos --size=10240 --grow
logvol /home --fstype=xfs --name=home --vgname=centos --size=2048
logvol /var --fstype=xfs --name=var --vgname=centos --size=5120
logvol /tmp --fstype=xfs --name=tmp --vgname=centos --size=2048

# ============================================
# 认证配置
# ============================================
authconfig --enableshadow --passalgo=sha512

# ============================================
# SELinux 和防火墙配置
# ============================================
# SELinux：enforcing（强制）、permissive（宽松）、disabled（禁用）
selinux --enforcing

# 防火墙配置
firewall --enabled --service=ssh

# ============================================
# 显示配置
# ============================================
# 图形界面安装（需要更多资源）
# graphical

# 文本模式安装（推荐用于服务器）
text

# 跳过 X 配置
skipx

# ============================================
# 软件包选择
# ============================================
%packages --nobase --ignoremissing

# 基础系统
@core
@development

# 基础工具
vim
wget
curl
git
net-tools
telnet
lsof
tree
htop
tmux
screen

# 网络工具
tcpdump
nmap
nc
bind-utils

# 系统监控
sysstat
iotop

# 开发工具（可选）
# @development-tools
# gcc
# make
# automake

# Web 服务器（根据需要选择）
# httpd
# nginx
# php
# mysql

%end

# ============================================
# 安装前脚本（%pre）
# 在安装开始前执行，chroot 环境外
# ============================================
%pre
#!/bin/bash
# 这里可以添加安装前的检查和配置

# 检查硬件
echo "=== Hardware Information ==="
cat /proc/cpuinfo | grep "model name" | head -1
cat /proc/meminfo | grep MemTotal

# 检查网络
echo "=== Network Information ==="
ip addr show

%end

# ============================================
# 安装后脚本（%post）
# 在安装完成后执行，第一次启动时运行
# ============================================
%post --log=/root/ks-post.log
#!/bin/bash
# ============================================
# 基础系统配置
# ============================================

echo "=========================================="
echo "Starting post-installation configuration"
echo "=========================================="

# 更新系统
echo "Updating system..."
yum clean all
yum makecache
yum update -y

# 安装 EPEL 源
echo "Installing EPEL repository..."
yum install -y epel-release

# 安装额外工具
echo "Installing additional tools..."
yum install -y htop iftop iotop jq rsync

# ============================================
# 用户配置
# ============================================

# 创建普通用户
echo "Creating user 'deploy'..."
useradd -m -s /bin/bash deploy
echo "deploy:Deploy123!" | chpasswd

# 配置 sudo 权限
echo "deploy ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/deploy
chmod 440 /etc/sudoers.d/deploy

# ============================================
# SSH 配置
# ============================================

echo "Configuring SSH..."

# 禁用 root 登录
sed -i 's/^#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# 禁用密码认证（建议使用密钥认证）
# sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# 启动 SSH 服务
systemctl enable sshd
systemctl start sshd

# ============================================
# 系统优化
# ============================================

echo "Optimizing system settings..."

# 内核参数优化
cat >> /etc/sysctl.conf << 'EOF'
# 网络优化
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.core.somaxconn = 65535

# 文件句柄
fs.file-max = 65535
EOF

# 应用内核参数
sysctl -p

# 文件描述符限制
cat >> /etc/security/limits.conf << 'EOF'
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
EOF

# ============================================
# 时区和时间同步
# ============================================

echo "Configuring time sync..."

# 安装并启用 chrony
yum install -y chrony
systemctl enable chronyd
systemctl start chronyd

# ============================================
# 自定义脚本或应用部署
# ============================================

# 这里可以添加你的自定义初始化脚本
# 例如：下载并安装应用、配置服务、导入数据等

echo "=========================================="
echo "Post-installation configuration completed"
echo "=========================================="

%end

# ============================================
# 安装完成后的操作
# ============================================
# 重新启动系统
reboot

# 如果想关机，使用：
# poweroff
