# Ubuntu 20.04 LTS Preseed 配置文件
# 用于自动化安装 Ubuntu 20.04

# ============================================
# 本地化设置
# ============================================
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# ============================================
# 网络配置
# ============================================
# 使用 DHCP 自动配置网络
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean false
d-i netcfg/get_hostname string ubuntu2004
d-i netcfg/get_domain string local

# 禁用网络唤醒（可选）
d-i netcfg/wireless_wep string

# ============================================
# 镜像设置
# ============================================
d-i mirror/country string manual
d-i mirror/http/hostname string 192.168.1.10
d-i mirror/http/directory string /iso/ubuntu2004
d-i mirror/http/proxy string

# ============================================
# 时区和时钟设置
# ============================================
d-i time/zone string Asia/Shanghai
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

# ============================================
# 分区配置
# ============================================
# 使用 LVM 自动分区
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# 分区方案
d-i partman-auto/expert_recipe string \
    boot-root :: \
        512 512 512 ext4 \
            $primary{ } \
            $bootable{ } \
            method{ format } \
            format{ } \
            use_filesystem{ } \
            filesystem{ ext4 } \
            mountpoint{ /boot } \
        . \
        10240 5120 -1 ext4 \
            $lvmok{ } \
            method{ format } \
            format{ } \
            use_filesystem{ } \
            filesystem{ ext4 } \
            mountpoint{ / } \
        . \
        4096 2048 -1 linux-swap \
            $lvmok{ } \
            method{ swap } \
            format{ } \
        .

# 确认分区操作
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# ============================================
# 用户和密码设置
# ============================================
# 设置 root 密码（默认禁用 root 登录）
d-i passwd/root-login boolean false
# 如果要启用 root：
# d-i passwd/root-password password rootpass
# d-i passwd/root-password-again password rootpass

# 创建普通用户
d-i passwd/user-fullname string Deploy User
d-i passwd/username string deploy
d-i passwd/user-password password Deploy123!
d-i passwd/user-password-again password Deploy123!

# 给用户 sudo 权限
d-i passwd/user-default-groups string audio cdrom video sudo

# ============================================
# 认证设置
# ============================================
d-i passwd/shadow boolean true

# ============================================
# 引导装载程序
# ============================================
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default

# ============================================
# 软件包选择
# ============================================
tasksel tasksel/first multiselect standard, ubuntu-server

# 安装额外软件包
d-i pkgsel/include string openssh-server vim curl wget git htop tmux build-essential

# 不安装推荐软件包（节省空间）
d-i pkgsel/install-language-support boolean false
d-i pkgsel/language-packs multiselect

# 在安装时不更新（加快安装速度）
d-i pkgsel/upgrade select none

# ============================================
# 安装后设置
# ============================================
# 使用网络镜像
d-i apt-setup/use_mirror boolean true

# 启用安全更新仓库
d-i apt-setup/security_host string security.ubuntu.com

# ============================================
# 安装后脚本（late_command）
# ============================================
d-i preseed/late_command string \
    in-target chmod 755 /root; \
    in-target wget -O /root/post-install.sh http://192.168.1.10:8080/ks/ubuntu2004-post.sh || true; \
    in-target chmod +x /root/post-install.sh || true; \
    in-target /root/post-install.sh || true; \
    in-target rm -f /root/post-install.sh

# ============================================
# 完成安装
# ============================================
d-i finish-install/reboot_in_progress note

# 不弹出安装介质（如果是 DVD 安装）
d-i cdrom-detect/eject boolean false

# 电源管理
d-i finish-install/keep-consoles boolean true
d-i finish-install/automatic-reboot boolean true

# ============================================
# 高级设置
# ============================================

# 禁用安装完成时的交互
d-i debian-installer/quiet boolean true
d-i debian-installer/splash boolean false

# ============================================
# SSH 配置
# ============================================
# 预配置 SSH
d-i preseed/early_command string \
    anna-install libfribidi0 || true

# ============================================
# 网络安装配置
# ============================================
# 如果使用 mini.iso 或网络安装
d-i hw-detect/load_firmware boolean true

# ============================================
# 以下为自定义配置说明
# ============================================
#
# 注意：上述 late_command 会尝试下载并执行 post-install.sh
# 你需要在 HTTP 服务器的 /ks/ 目录创建 ubuntu2004-post.sh
#
# ubuntu2004-post.sh 示例内容：
#
# #!/bin/bash
# set -e
#
# # 更新系统
# apt-get update
# apt-get upgrade -y
#
# # 安装额外软件
# apt-get install -y ufw fail2ban
#
# # 配置防火墙
# ufw allow 22/tcp
# ufw --force enable
#
# # 配置 SSH
# sed -i 's/^#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
#
# # 配置时区
# timedatectl set-timezone Asia/Shanghai
#
# # 清理
# apt-get clean
#
# echo "Post-installation completed" > /var/log/post-install.log
#
