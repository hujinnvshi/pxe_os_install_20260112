# CentOS Stream 8 / Rocky Linux 8 / AlmaLinux 8 Kickstart 配置文件
# 用于自动化安装 RHEL 8 系列系统

# ============================================
# 安装方式
# ============================================
install

# 从网络安装（HTTP/FTP/NFS）
url --url="http://192.168.1.10:8080/iso/centos8"

# 如果使用完整安装光盘：
# cdrom

# 如果使用 NFS：
# nfs --server=192.168.1.10 --dir=/iso/centos8

# ============================================
# 语言和键盘配置
# ============================================
lang en_US.UTF-8
keyboard us

# ============================================
# 网络配置
# ============================================
# 自动获取 IP（DHCP）
network --onboot=yes --device=eth0 --bootproto=dhcp --noipv6

# 如果使用静态 IP：
# network --onboot=yes --device=eth0 --bootproto=static --ip=192.168.1.100 --netmask=255.255.255.0 --gateway=192.168.1.1 --nameserver=8.8.8.8

# ============================================
# 时区和密码
# ============================================
timezone Asia/Shanghai --isUtc

# root 密码：password123（请修改！）
# 生成加密密码：openssl passwd -6 "yourpassword"
rootpw --iscrypted $6$rounds=656000$OqJl.kPl$QZ...请替换为实际密码

# 或者使用明文（不推荐）：
# rootpw "yourpassword"

# ============================================
# 引导装载程序
# ============================================
# 安装引导装载程序到 MBR
bootloader --location=mbr --boot-drive=sda

# 如果使用 UEFI：
# bootloader --location=partition --driveorder=sda

# ============================================
# 分区配置
# ============================================
# 清除所有现有分区
clearpart --all --initlabel

# 自动分区（使用 LVM）
# autopart --type=lvm --nohome

# 或者手动分区（推荐）
part /boot --fstype=xfs --size=1024 --ondisk=sda
part swap --size=4096 --ondisk=sda
part /boot/efi --fstype=efi --size=512 --ondisk=sda   # UEFI 系统需要
part pv.01 --size=1 --grow --ondisk=sda
volgroup centos pv.01
logvol / --fstype=xfs --name=root --vgname=centos --size=10240 --grow
logvol /home --fstype=xfs --name=home --vgname=centos --size=2048
logvol /var --fstype=xfs --name=var --vgname=centos --size=5120
logvol /tmp --fstype=xfs --name=tmp --vgname=centos --size=2048
logvol /var/log --fstype=xfs --name=log --vgname=centos --size=1024

# ============================================
# 认证配置
# ============================================
authconfig --enableshadow --passalgo=sha512

# ============================================
# SELinux 和防火墙配置
# ============================================
# SELinux：enforcing（强制）、permissive（宽松）、disabled（禁用）
selinux --enforcing

# 防火墙配置
firewall --enabled --service=ssh --service=http --service=https

# ============================================
# 显示配置
# ============================================
# 文本模式安装（推荐用于服务器）
text

# 跳过 X 配置
skipx

# ============================================
# 软件包选择
# ============================================
%packages --excludedocs --inst-langs=en_US

# 基础系统
@core
@standard
@development

# 基础工具
vim
wget
curl
git
net-tools
telnet
lsof
tree
htop
tmux
screen
bash-completion

# 网络工具
tcpdump
nmap
nc
bind-utils
traceroute
mtr

# 系统监控
sysstat
iotop
nethogs

# 额外的开发工具
gcc
make
automake
cmake
python3
python3-pip

# 编辑器
vim-enhanced
nano

# 安全工具
sudo
policycoreutils-python-utils
setools-console

%end

# ============================================
# 安装前脚本（%pre）
# 在安装开始前执行
# ============================================
%pre
#!/bin/bash
# 安装前检查

echo "=========================================="
echo "PXE Installation - CentOS 8"
echo "=========================================="
echo "Hardware Information:"
cat /proc/cpuinfo | grep "model name" | head -1
echo "Memory:"
free -h
echo "Network:"
ip addr show

%end

# ============================================
# 安装后脚本（%post）
# 在安装完成后执行
# ============================================
%post --log=/root/ks-post.log
#!/bin/bash
# ============================================
# 基础系统配置
# ============================================

echo "=========================================="
echo "Starting post-installation configuration"
echo "=========================================="

# 更新系统
echo "Updating system..."
dnf clean all
dnf makecache
dnf update -y

# 安装 EPEL 源
echo "Installing EPEL repository..."
dnf install -y epel-release

# 安装额外工具
echo "Installing additional tools..."
dnf install -y htop iftop iotop jq rsync fail2ban

# ============================================
# 用户配置
# ============================================

echo "Creating user 'deploy'..."
useradd -m -s /bin/bash deploy
echo "deploy:Deploy123!" | chpasswd

# 配置 sudo 权限
echo "deploy ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/deploy
chmod 440 /etc/sudoers.d/deploy

# ============================================
# SSH 配置
# ============================================

echo "Configuring SSH..."

# 禁用 root 登录
sed -i 's/^#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# 禁用密码认证（建议使用密钥）
# sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# 启用 SSH 服务
systemctl enable sshd
systemctl start sshd

# ============================================
# 系统优化
# ============================================

echo "Optimizing system settings..."

# 内核参数优化
cat >> /etc/sysctl.d/99-custom.conf << 'EOF'
# 网络优化
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.core.somaxconn = 65535

# 文件句柄
fs.file-max = 65535

# 共享内存
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
EOF

# 应用内核参数
sysctl -p /etc/sysctl.d/99-custom.conf

# 文件描述符限制
cat >> /etc/security/limits.d/99-custom.conf << 'EOF'
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
EOF

# ============================================
# 时区和时间同步
# ============================================

echo "Configuring time sync..."

# 安装并启用 chrony
dnf install -y chrony
systemctl enable chronyd
systemctl start chronyd

# ============================================
# 禁用不必要的服务
# ============================================

echo "Disabling unnecessary services..."
systemctl disable postfix
systemctl stop postfix

# ============================================
# 配置日志轮转
# ============================================

cat > /etc/logrotate.d/custom << 'EOF'
/var/log/messages /var/log/secure {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
EOF

# ============================================
# 自定义 MOTD
# ============================================

cat > /etc/motd << 'EOF'
========================================
Welcome to CentOS 8 / Rocky Linux 8
========================================
System installed via PXE on $(date)
For support, contact: admin@example.com
========================================
EOF

# ============================================
# 安装后清理
# ============================================

echo "Cleaning up..."
dnf clean all
rm -rf /var/cache/dnf/*

echo "=========================================="
echo "Post-installation configuration completed"
echo "=========================================="
echo "Please change the default passwords!"
echo "Root and deploy user passwords should be changed immediately."
echo "=========================================="

%end

# ============================================
# 安装完成后的操作
# ============================================
# 重新启动系统
reboot

# 如果想关机：
# poweroff
